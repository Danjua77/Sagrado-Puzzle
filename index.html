<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puzzle Sagrado</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            min-height: 100vh;
            min-width: 100vw;
            width: 100vw;
            height: 100vh;
            box-sizing: border-box;
            background: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .container {
            width: 100vw;
            height: 100vh;
            max-width: 430px;
            max-height: 932px;
            min-width: 320px;
            min-height: 568px;
            background: url('Fondo.jpg') no-repeat center center;
            background-size: cover;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px 2px rgba(0,0,0,0.2);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }
        .titulo-sagrado {
            font-family: 'Montserrat', Arial, sans-serif;
            font-size: 3.7rem;
            color: #178a2c;
            font-weight: 700;
            text-align: center;
            line-height: 1.1;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 12px #fff, 0 0 12px #178a2c, 2px 2px 0 #fff, 0 0 0 #fff;
            letter-spacing: 1px;
        }
        .idioma-select {
            margin: 1.5rem 0 1.5rem 0;
            font-size: 1.2rem;
            padding: 0.5rem 2rem 0.5rem 1rem;
            border-radius: 8px;
            border: 2px solid #fff;
            background: #178a2c;
            color: #fff;
            font-weight: bold;
            font-family: 'Roboto', Arial, sans-serif;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            outline: none;
        }
        .idioma-select option {
            color: #178a2c;
            background: #fff;
        }
        .instrucciones {
            font-size: 1.7rem;
            color: #178a2c;
            font-weight: 700;
            text-align: center;
            margin-bottom: 2rem;
            font-family: 'Roboto', Arial, sans-serif;
            text-shadow: 0 1px 6px #fff, 0 0 6px #178a2c, 1px 1px 0 #fff, 0 0 0 #fff;
        }
        .codigo-container {
            display: flex;
            gap: 1.2rem;
            margin-bottom: 2.5rem;
        }
        .codigo-input {
            width: 55px;
            height: 55px;
            font-size: 2.2rem;
            text-align: center;
            border: 4px solid #666;
            border-radius: 10px;
            background: transparent;
            outline: none;
            color: #ffe44d;
            font-family: 'Montserrat', Arial, sans-serif;
            font-weight: bold;
            transition: border 0.2s, background 0.2s;
            pointer-events: auto;
        }
        .codigo-input:focus, .codigo-input.active {
            border: 4px solid #178a2c;
            background: rgba(255,255,255,0.7);
        }
        .btn-aceptar {
            font-size: 1.5rem;
            background: #178a2c;
            color: #fff;
            border: 3px solid #fff;
            border-radius: 8px;
            padding: 0.7rem 2.5rem;
            font-weight: bold;
            font-family: 'Montserrat', Arial, sans-serif;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            cursor: pointer;
            transition: background 0.2s, border 0.2s;
        }
        .btn-aceptar:active {
            background: #176d13;
            border: 3px solid #ffe44d;
        }
        /* Mejoras visuales para responsividad */
        @media (max-width: 430px) {
            .container {
                width: 100vw;
                height: 100vh;
                max-width: 100vw;
                max-height: 100vh;
                border-radius: 0;
                box-shadow: none;
            }
            .titulo-sagrado {
                font-size: 2.5rem;
            }
            .codigo-input {
                width: 40px;
                height: 40px;
                font-size: 1.3rem;
            }
        }
        .fade-out {
            opacity: 0;
            transition: opacity 1.2s ease;
        }
        .fade-in {
            opacity: 1;
            transition: opacity 1.2s ease;
        }
        .hidden {
            display: none !important;
        }
        .arbol-chan-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: opacity 1.2s ease;
        }
        .arbol-chan-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 350px;
            margin: 0 auto;
        }
        .arbol-chan-img {
            width: 60vw;
            max-width: 220px;
            min-width: 120px;
            margin-top: 0;
            opacity: 0;
            transition: opacity 1.2s, transform 1.2s cubic-bezier(.77,0,.18,1);
            transform: translateY(-120px);
        }
        .arbol-chan-img.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .arbol-chan-titulo {
            font-family: 'Montserrat', Arial, sans-serif;
            color: #178a2c;
            font-size: 2.5rem;
            font-weight: bold;
            margin-top: 1.2rem;
            margin-bottom: 0.7rem;
            text-align: center;
            text-shadow: 0 2px 12px #fff, 0 0 12px #178a2c, 2px 2px 0 #fff;
        }
        .arbol-chan-texto {
            color: #fff;
            font-family: 'Roboto', Arial, sans-serif;
            font-size: 1.2rem;
            margin-top: 0.5rem;
            margin-bottom: 1.2rem;
            text-align: center;
            text-shadow: 0 2px 8px #000;
        }
        .btn-continuar {
            margin-top: 0.5rem;
            font-size: 1.2rem;
            background: #178a2c;
            color: #fff;
            border: 2px solid #fff;
            border-radius: 8px;
            padding: 0.7rem 2.5rem;
            font-weight: bold;
            font-family: 'Montserrat', Arial, sans-serif;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            cursor: pointer;
            transition: background 0.2s, border 0.2s;
        }
        .btn-continuar:active {
            background: #176d13;
            border: 2px solid #ffe44d;
        }
        /* Fondo especial para la pantalla de mesa */
        .mesa-fondo {
            width: 100vw;
            height: 100vh;
            max-width: 430px;
            max-height: 932px;
            min-width: 320px;
            min-height: 568px;
            background: url('fonde mesa.jpg') no-repeat center center;
            background-size: cover;
            border-radius: 20px;
            box-shadow: 0 0 20px 2px rgba(0,0,0,0.2);
            position: relative;
        }
        @media (max-width: 430px) {
            .mesa-fondo {
                width: 100vw;
                height: 100vh;
                max-width: 100vw;
                max-height: 100vh;
                border-radius: 0;
                box-shadow: none;
            }
        }
        @keyframes shake {
            0% { transform: translateX(0); }
            15% { transform: translateX(-12px); }
            30% { transform: translateX(10px); }
            45% { transform: translateX(-8px); }
            60% { transform: translateX(6px); }
            75% { transform: translateX(-4px); }
            90% { transform: translateX(2px); }
            100% { transform: translateX(0); }
        }
        .shake {
            animation: shake 0.45s cubic-bezier(.36,.07,.19,.97) both;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="titulo-sagrado" id="titulo-sagrado">Sagrado<br>Puzzle</h1>
        <select class="idioma-select" id="idioma-select">
            <option value="es">Español</option>
            <option value="en">English</option>
        </select>
        <div class="instrucciones" id="instrucciones">Busca las pistas e ingresa los<br>códigos secretos</div>
        <div class="codigo-container">
            <input class="codigo-input" maxlength="1" autocomplete="off" />
            <input class="codigo-input" maxlength="1" autocomplete="off" />
            <input class="codigo-input" maxlength="1" autocomplete="off" />
            <input class="codigo-input" maxlength="1" autocomplete="off" />
            <input class="codigo-input" maxlength="1" autocomplete="off" />
        </div>
        <button class="btn-aceptar" id="btn-aceptar">Aceptar</button>
    </div>
    <div class="arbol-chan-container" id="arbol-chan-container">
        <div class="arbol-chan-content">
            <img src="DonArbol.png" class="arbol-chan-img" id="arbol-chan-img" alt="Don Árbolito" />
            <div class="arbol-chan-titulo" id="arbol-chan-titulo">Don Árbolito</div>
            <div class="arbol-chan-texto" id="arbol-chan-texto">Estimado Usuario, debo confesar que me resulta lamentable negarle la pista sin más…
Pero comprenderá usted que, en su noble cruzada por la búsqueda del caché, los logros deben ser alcanzados con honor y elegancia.</div>
            <button class="btn-continuar" id="btn-continuar">Continuar</button>
        </div>
    </div>
    <!-- GYMBRO CONTAINER -->
    <div class="arbol-chan-container" id="gymbro-container" style="z-index:11;">
        <div class="arbol-chan-content">
            <img src="gymbro.png" class="arbol-chan-img" id="gymbro-img" alt="Gym Bro" />
            <div class="arbol-chan-titulo" id="gymbro-titulo">Gym Bro</div>
            <div class="arbol-chan-texto" id="gymbro-texto"></div>
            <button class="btn-continuar" id="gymbro-continuar"></button>
        </div>
    </div>
    <script>
        // Interacción para inputs: foco automático y estilos
        const inputs = document.querySelectorAll('.codigo-input');
        inputs.forEach((input, idx) => {
            input.addEventListener('focus', () => {
                input.classList.add('active');
            });
            input.addEventListener('blur', () => {
                input.classList.remove('active');
            });
            input.addEventListener('input', (e) => {
                if (input.value.length === 1 && idx < inputs.length - 1) {
                    inputs[idx + 1].focus();
                }
            });
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && input.value === '' && idx > 0) {
                    inputs[idx - 1].focus();
                }
            });
        });

        // Cambio de idioma
        const idiomaSelect = document.getElementById('idioma-select');
        const titulo = document.getElementById('titulo-sagrado');
        const instrucciones = document.getElementById('instrucciones');
        const btnAceptar = document.getElementById('btn-aceptar');
        const arbolChanTitulo = document.getElementById('arbol-chan-titulo');
        const arbolChanTexto = document.getElementById('arbol-chan-texto');
        const gymbroTitulo = document.getElementById('gymbro-titulo');
        const gymbroTexto = document.getElementById('gymbro-texto');
        const gymbroContinuar = document.getElementById('gymbro-continuar');
        let currentLang = idiomaSelect.value;

        // Textos en ambos idiomas, incluyendo Gym Bro
        const textos = {
            es: {
                titulo: 'Sagrado<br>Puzzle',
                instrucciones: 'Busca las pistas e ingresa los<br>códigos secretos',
                aceptar: 'Aceptar',
                arbolTitulo: 'Don Árbolito',
                arbolTexto: 'Estimado usuario, debo confesar que me resulta lamentable negarle la pista sin más…<br>Pero comprenderá usted que, en su noble búsqueda por la búsqueda del caché, los logros deben alcanzados con honor y elegancia.',
                continuar: 'Continuar',
                mesa: '¡Bienvenido a la mesa sagrada!',
                pongWin: 'Siguiente pista',
                pongLose: 'Bro....<br>continuar',
                gymbroTitulo: 'Gym Bro',
                gymbro1: 'Bro… ¿De verdad crees que puedes tener la pista así de fácil? He visto bebes con más masa muscular que tú.',
                gymbro2: 'Demuestra que eres un real Bro™. aguanta estas pesas sin derramar una sola gota de sudor el tiempo que sea necesario.',
                gymbroContinuar: 'Continuar',
            },
            en: {
                titulo: 'Sagrado<br>Puzzle',
                instrucciones: 'Search for the clues and enter the<br>secret codes',
                aceptar: 'Accept',
                arbolTitulo: 'Don Árbolito',
                arbolTexto: 'Dear user, I must confess that I regret denying you the clue just like that…<br>But you will understand that, in your noble quest for the cache, achievements must be reached with honor and elegance.',
                continuar: 'Continue',
                mesa: 'Welcome to the sacred table!',
                pongWin: 'Next clue',
                pongLose: 'You lost!<br>Try again',
                gymbroTitulo: 'Gym Bro',
                gymbro1: 'Bro... Do you really think you can get the clue that easy? I\'ve seen babies with more muscle mass than you.',
                gymbro2: 'Show you\'re a real Bro™. hold these weights without breaking a sweat for as long as it takes.',
                gymbroContinuar: 'Continue',
            }
        };

        function updateTexts(lang) {
            titulo.innerHTML = textos[lang].titulo;
            instrucciones.innerHTML = textos[lang].instrucciones;
            btnAceptar.textContent = textos[lang].aceptar;
            arbolChanTitulo.textContent = textos[lang].arbolTitulo;
            arbolChanTexto.innerHTML = textos[lang].arbolTexto;
            btnContinuar.textContent = textos[lang].continuar;
            gymbroTitulo.textContent = textos[lang].gymbroTitulo;
            gymbroContinuar.textContent = textos[lang].gymbroContinuar;
            // Si está visible, actualiza el texto actual
            if (gymbroDialogStep === 0) {
                gymbroTexto.textContent = textos[lang].gymbro1;
            } else if (gymbroDialogStep === 1) {
                gymbroTexto.textContent = textos[lang].gymbro2;
            }
            currentLang = lang;
        }

        idiomaSelect.addEventListener('change', function() {
            updateTexts(idiomaSelect.value);
            const mesaTexto = document.getElementById('mesa-texto');
            if (mesaTexto) {
                mesaTexto.textContent = textos[idiomaSelect.value].mesa;
            }
        });

        const container = document.querySelector('.container');
        const arbolChanContainer = document.getElementById('arbol-chan-container');
        const arbolChanImg = document.getElementById('arbol-chan-img');
        const btnContinuar = document.getElementById('btn-continuar');
        const gymbroContainer = document.getElementById('gymbro-container');
        const gymbroImg = document.getElementById('gymbro-img');
        gymbroContainer.style.opacity = 0;
        gymbroContainer.style.pointerEvents = 'none';
        gymbroImg.classList.remove('visible');

        document.getElementById('btn-aceptar').addEventListener('click', function() {
            const code = Array.from(document.querySelectorAll('.codigo-input')).map(i => i.value).join('');
            if (code === '18122') {
                container.classList.add('fade-out');
                setTimeout(() => {
                    container.style.backgroundImage = "url('Fondo texto.jpg')";
                    container.classList.remove('fade-out');
                    container.classList.add('fade-in');
                    Array.from(container.children).forEach(child => {
                        if (!child.classList.contains('arbol-chan-container')) {
                            child.classList.add('hidden');
                        }
                    });
                    setTimeout(() => {
                        arbolChanContainer.style.opacity = 1;
                        arbolChanContainer.style.pointerEvents = 'auto';
                        setTimeout(() => {
                            arbolChanImg.classList.add('visible');
                        }, 800);
                    }, 1200);
                }, 1200);
            } else if (code === '13777') {
                // --- GYMBRO SEQUENCE ---
                // Oculta todo menos el contenedor de Gym Bro
                container.classList.add('fade-out');
                setTimeout(() => {
                    container.style.backgroundImage = "url('Fondo texto.jpg')";
                    container.classList.remove('fade-out');
                    container.classList.add('fade-in');
                    Array.from(container.children).forEach(child => {
                        if (!child.classList.contains('arbol-chan-container')) {
                            child.classList.add('hidden');
                        }
                    });
                    setTimeout(() => {
                        // Configura textos e imagen
                        gymbroTitulo.textContent = textos[currentLang].gymbroTitulo;
                        gymbroTexto.textContent = textos[currentLang].gymbro1;
                        gymbroContinuar.textContent = textos[currentLang].gymbroContinuar;
                        gymbroContainer.style.opacity = 1;
                        gymbroContainer.style.pointerEvents = 'auto';
                        setTimeout(() => {
                            gymbroImg.classList.add('visible');
                        }, 800);
                    }, 1200);
                }, 1200);
                gymbroDialogStep = 0;
            } else {
                container.classList.remove('shake');
                void container.offsetWidth;
                container.classList.add('shake');
                setTimeout(() => {
                    container.classList.remove('shake');
                }, 450);
            }
        });

        // Secuencia de diálogos Gym Bro
        let gymbroDialogStep = 0;
        gymbroContinuar.addEventListener('click', function() {
            if (gymbroDialogStep === 0) {
                gymbroTexto.textContent = textos[currentLang].gymbro2;
                gymbroDialogStep = 1;
            } else {
                // --- INICIO DEL MINIJUEGO DE GYMBRO (FLAPPY TOUCH) ---
                // Elimina el audio de fondo si existe
                let oldAudio = document.getElementById('pong-audio');
                if (oldAudio) oldAudio.remove();

                // Reemplaza el body por el minijuego Flappy Touch con estética adaptada
                document.body.innerHTML = `
                    <style>
                        body {
                          margin: 0;
                          background: url('fonde mesa.jpg') no-repeat center center, linear-gradient(180deg, #e8f5e9 0%, #178a2c 100%);
                          background-size: cover;
                          display: flex;
                          justify-content: center;
                          align-items: center;
                          height: 100vh;
                          overflow: hidden;
                        }
                        #flappy-container {
                          width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center;
                          flex-direction: column;
                          position: fixed; top: 0; left: 0;
                        }
                        #flappy-canvas {
                          background: #fff; /* Cambiado de 'transparent' a blanco */
                          display: block;
                          margin: auto;
                          width: 92vw;
                          height: 70vh;
                          max-width: 370px;
                          max-height: 620px;
                          aspect-ratio: 9/16;
                          border-radius: 18px;
                          box-shadow: 0 0 32px 4px #178a2c88, 0 0 0 4px #178a2c;
                          touch-action: none;
                        }
                        #flappy-end {
                          position: absolute;
                          top: 0; left: 0; width: 100vw; height: 100vh;
                          background: url('Fondo texto.jpg') no-repeat center center;
                          background-size: cover;
                          color: #178a2c;
                          display: flex;
                          flex-direction: column;
                          align-items: center;
                          justify-content: center;
                          z-index: 10;
                          font-family: 'Montserrat', Arial, sans-serif;
                        }
                        #flappy-end .arbol-img {
                          width: 38vw;
                          max-width: 180px;
                          min-width: 90px;
                          margin-top: 2.5rem;
                          margin-bottom: 1.2rem;
                          filter: drop-shadow(0 4px 16px #fff);
                        }
                        #flappy-end h2 {
                          font-size: 2.2rem;
                          margin-bottom: 2rem;
                          color: #178a2c;
                          text-align: center;
                          text-shadow: 0 2px 12px #fff, 0 0 12px #178a2c, 2px 2px 0 #fff;
                          margin-top: 0;
                        }
                        #flappy-pista-img {
                          margin-top: 18px;
                          margin-bottom: 8px;
                          width: 60vw;
                          max-width: 300px;
                          min-width: 120px;
                          height: 180px;
                          background: #fff;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          border-radius: 12px;
                          overflow: hidden;
                          box-shadow: 0 2px 12px #178a2c33;
                        }
                        #flappy-end button, #retry-btn, #flappy-next-btn {
                          font-size: 1.3rem;
                          background: #178a2c;
                          color: #fff;
                          border: 2px solid #fff;
                          border-radius: 8px;
                          padding: 0.7rem 2.5rem;
                          font-weight: bold;
                          font-family: 'Montserrat', Arial, sans-serif;
                          box-shadow: 0 2px 8px rgba(0,0,0,0.12);
                          cursor: pointer;
                          margin-top: 1.5rem;
                          margin-bottom: 2rem;
                          transition: background 0.2s, border 0.2s;
                        }
                        #flappy-end button:active, #retry-btn:active, #flappy-next-btn:active {
                          background: #176d13;
                          border: 2px solid #ffe44d;
                        }
                        #flappy-timer {
                          margin-top: 18px;
                          color: #fff;
                          font-family: 'Montserrat', Arial, sans-serif;
                          font-size: 1.1rem;
                          font-weight: bold;
                          text-shadow: 0 2px 8px #000, 0 0 8px #178a2c;
                          z-index: 20;
                          pointer-events: none;
                          user-select: none;
                          letter-spacing: 0.5px;
                          text-align: center;
                        }
                    </style>
                    <div id="flappy-container">
                      <canvas id="flappy-canvas" width="320" height="480"></canvas>
                      <div id="flappy-timer"></div>
                    </div>
                    <div id="flappy-end" style="display:none;">
                      <div id="flappy-end-content"></div>
                    </div>
                `;

                // Traducción de textos
                const lang = currentLang === 'en' ? 'en' : 'es';
                const texts = {
                  es: {
                    lose: "¡Perdiste!",
                    win: "¡Ganaste!",
                    retry: "Intentar de nuevo",
                    next: "Ver pista",
                    continue: "Continuar"
                  },
                  en: {
                    lose: "You lost!",
                    win: "You won!",
                    retry: "Try again",
                    next: "See clue",
                    continue: "Continue"
                  }
                };

                // Lógica Flappy Touch adaptada (canvas y colores igual que Pong)
                (function() {
                  const canvas = document.getElementById('flappy-canvas');
                  const ctx = canvas.getContext('2d');
                  const flappyEnd = document.getElementById('flappy-end');
                  const flappyEndContent = document.getElementById('flappy-end-content');
                  const flappyTimer = document.getElementById('flappy-timer');

                  let birdY, velocity, gameStarted, countdown, lastPhaseTime, animationStartTime, repetitions;
                  let currentTargetIndex, currentOffset, time, gameTimer, gameTimerInterval;
                  let inFinalMilliseconds, finalMilliseconds, activeBonuses, gameOver;
                  const gravity = 0.25;
                  const birdX = canvas.width / 2;
                  const phaseOffsets = [60, 90, 120, 150];
                  const maxRepetitions = 5;
                  let phaseAnimationActive = true;
                  let topLineY = 0;
                  let bottomLineY = 0;

                  function resetGame() {
                    birdY = canvas.height / 2;
                    velocity = 0;
                    gameStarted = false;
                    countdown = 3;
                    lastPhaseTime = 0;
                    animationStartTime = null;
                    repetitions = 0;
                    currentTargetIndex = 0;
                    currentOffset = phaseOffsets[0];
                    time = 0;
                    gameTimer = 30;
                    inFinalMilliseconds = false;
                    finalMilliseconds = 900;
                    activeBonuses = [];
                    gameOver = false;
                    phaseAnimationActive = true;
                    flappyEnd.style.display = 'none';
                    clearInterval(gameTimerInterval);
                    startCountdown();
                    update();
                  }

                  function updateTargetOffset() {
                    const phaseDuration = 300;
                    const nextTargetIndex = Math.min(Math.floor(time / phaseDuration), phaseOffsets.length - 1);
                    if (nextTargetIndex !== currentTargetIndex) {
                      currentTargetIndex = nextTargetIndex;
                      lastPhaseTime = performance.now();
                    }
                  }

                  function smoothOffset() {
                    const target = phaseOffsets[currentTargetIndex];
                    const progress = Math.min(time / 200, 1);
                    const factor = 0.01 + progress * (0.05 - 0.01);
                    currentOffset += (target - currentOffset) * factor;
                    return currentOffset;
                  }

                  // Cargar la imagen de las pesas
                  const pesasImg = new Image();
                  pesasImg.src = 'pesas1.png';

                  function drawBird() {
                    // Dibuja la imagen de las pesas en vez de los círculos amarillos
                    const imgWidth = 128;   // antes: 64
                    const imgHeight = 64;   // antes: 32
                    if (pesasImg.complete) {
                      ctx.drawImage(
                        pesasImg,
                        birdX - imgWidth / 2,
                        birdY - imgHeight / 2,
                        imgWidth,
                        imgHeight
                      );
                    } else {
                      pesasImg.onload = () => {
                        ctx.drawImage(
                          pesasImg,
                          birdX - imgWidth / 2,
                          birdY - imgHeight / 2,
                          imgWidth,
                          imgHeight
                        );
                      };
                    }
                  }

                  function drawBoundaries() {
                    const now = performance.now();
                    const baseOffset = smoothOffset();
                    let offsetAnim = 0;
                    if (currentTargetIndex === phaseOffsets.length - 1) {
                      if (phaseAnimationActive) {
                        const elapsed = (now - lastPhaseTime) / 1000;
                        offsetAnim = Math.sin(elapsed * 2 * Math.PI / 10) * 100;
                        if (elapsed >= 10) {
                          animationStartTime = now;
                          phaseAnimationActive = false;
                        }
                      } else if (repetitions < maxRepetitions) {
                        const elapsed = (now - animationStartTime) / 1000;
                        const cycleDuration = 10;
                        const t = (elapsed % cycleDuration) / cycleDuration;
                        if (elapsed >= (repetitions + 1) * cycleDuration) repetitions++;
                        offsetAnim = Math.sin(t * 2 * Math.PI) * 100;
                      }
                    }
                    topLineY = baseOffset + offsetAnim;
                    bottomLineY = canvas.height - baseOffset + offsetAnim;
                    ctx.strokeStyle = '#e53935'; // Cambiado a rojo
                    ctx.lineWidth = 6;
                    ctx.beginPath();
                    ctx.moveTo(0, topLineY);
                    ctx.lineTo(canvas.width, topLineY);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(0, bottomLineY);
                    ctx.lineTo(canvas.width, bottomLineY);
                    ctx.stroke();
                  }

                  function checkCollision() {
                    const halfHeight = 12;
                    if (birdY - halfHeight < topLineY || birdY + halfHeight > bottomLineY) {
                      gameOver = true;
                      showLoseScreen();
                    }
                  }

                  function drawCountdown() {
                    ctx.fillStyle = '#178a2c';
                    ctx.font = 'bold 64px Montserrat, Arial, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.shadowColor = "#fff";
                    ctx.shadowBlur = 8;
                    ctx.fillText(countdown, canvas.width / 2, canvas.height / 2);
                    ctx.shadowBlur = 0;
                  }

                  function drawGameTimer() {
                    if (!gameStarted) return;
                    ctx.textAlign = 'center';
                    const timerText = inFinalMilliseconds ? (finalMilliseconds / 1000).toFixed(1) + 's' : gameTimer + 's';
                    ctx.fillStyle = '#178a2c'; // Cambiado a verde
                    ctx.font = 'bold 28px Montserrat, Arial, sans-serif';
                    ctx.shadowColor = "#178a2c";
                    ctx.shadowBlur = 8;
                    ctx.fillText(timerText, canvas.width / 2, 42);
                    ctx.shadowBlur = 0;
                    activeBonuses = activeBonuses.filter(b => performance.now() - b.start < 1500);
                    activeBonuses.forEach((b, index) => {
                      const alpha = 1 - (performance.now() - b.start) / 1500;
                      ctx.globalAlpha = alpha;
                      ctx.fillStyle = '#e53935'; // Cambiado a rojo
                      ctx.font = 'bold 20px Montserrat, Arial, sans-serif';
                      const offsetX = 30 + index * 30 + 3;
                      ctx.fillText('+5', canvas.width / 2 + offsetX, 42);
                      ctx.globalAlpha = 1;
                    });
                  }

                  function update() {
                    if (gameOver) return;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    if (!gameStarted) {
                      updateTargetOffset();
                      drawBoundaries();
                      drawBird();
                      drawCountdown();
                      time++;
                      requestAnimationFrame(update);
                      return;
                    }
                    velocity += gravity;
                    birdY += velocity;
                    if (birdY > canvas.height) birdY = canvas.height;
                    if (birdY < 0) {
                      birdY = 0;
                      velocity = 0;
                    }
                    updateTargetOffset();
                    drawBoundaries();
                    drawBird();
                    drawGameTimer();
                    checkCollision();
                    time++;
                    requestAnimationFrame(update);
                  }

                  function flap() {
                    if (!gameStarted || gameOver) return;
                    velocity = -5.4;
                  }

                  function startGameTimer() {
                    let bonusGiven = 0;
                    gameTimerInterval = setInterval(() => {
                      if (inFinalMilliseconds) {
                        finalMilliseconds -= 100;
                        if (finalMilliseconds <= 0) {
                          clearInterval(gameTimerInterval);
                          gameOver = true;
                          showWinScreen();
                        }
                        return;
                      }
                      gameTimer--;
                      if (gameTimer === 5 && bonusGiven < 3) {
                        gameTimer += 5;
                        bonusGiven++;
                        activeBonuses.push({ start: performance.now() });
                      }
                      if (gameTimer === 1 && bonusGiven >= 3) inFinalMilliseconds = true;
                      if (gameTimer <= 0) {
                        clearInterval(gameTimerInterval);
                        gameOver = true;
                        showWinScreen();
                      }
                    }, 1000);
                  }

                  function showWinScreen() {
                    flappyEnd.style.display = 'flex';
                    flappyEndContent.innerHTML = `
                      <div style="font-size:1.3rem;margin-bottom:0.7rem;">${texts[lang].next}</div>
                      <div id="flappy-pista-img">
                        <img src="13777.jpg" alt="Pista" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:12px;">
                      </div>
                      <button id="flappy-next-btn">${texts[lang].continue}</button>
                    `;
                    document.getElementById('flappy-next-btn').onclick = function() {
                      location.reload();
                    };
                  }

                  function showLoseScreen() {
                    // Pantalla de derrota igual a la de ping pong, pero con Gym Bro
                    flappyEnd.style.display = 'flex';
                    flappyEndContent.innerHTML = `
                      <div id="pong-end" style="background: #fff; color: #178a2c; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; font-family: 'Montserrat', Arial, sans-serif; width: 100vw; height: 100vh; position: absolute; top: 0; left: 0;">
                        <div class="arbol-chan-content" style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100vw; height: 100vh; max-width: 430px; max-height: 932px; min-width: 320px; min-height: 568px; margin: 0 auto; background: url('Fondo texto.jpg') no-repeat center center; background-size: cover; border-radius: 20px; box-shadow: 0 0 20px 2px rgba(0,0,0,0.2); position: relative;">
                          <img src="gymbro.png" class="arbol-chan-img visible" alt="Gym Bro" style="width: 60vw; max-width: 220px; min-width: 120px; margin-top: 0; opacity: 1; transform: translateY(0); transition: opacity 1.2s, transform 1.2s cubic-bezier(.77,0,.18,1);" />
                          <div class="arbol-chan-titulo" style="font-family: 'Montserrat', Arial, sans-serif; color: #178a2c; font-size: 2.5rem; font-weight: bold; margin-top: 1.2rem; margin-bottom: 0.7rem; text-align: center; text-shadow: 0 2px 12px #fff, 0 0 12px #178a2c, 2px 2px 0 #fff;">Gym Bro</div>
                          <div class="arbol-chan-texto" style="color: #fff; font-family: 'Roboto', Arial, sans-serif; font-size: 1.2rem; margin-top: 0.5rem; margin-bottom: 1.2rem; text-align: center; text-shadow: 0 2px 8px #000;">
                            ${texts[lang].lose}
                          </div>
                          <button id="retry-btn" class="btn-continuar" style="margin-top: 0.5rem; font-size: 1.2rem; background: #178a2c; color: #fff; border: 2px solid #fff; border-radius: 8px; padding: 0.7rem 2.5rem; font-weight: bold; font-family: 'Montserrat', Arial, sans-serif; box-shadow: 0 2px 8px rgba(0,0,0,0.12); cursor: pointer; transition: background 0.2s, border 0.2s;">${texts[lang].retry}</button>
                        </div>
                      </div>
                    `;
                    document.getElementById('retry-btn').onclick = function() {
                      location.reload();
                    };
                  }

                  document.body.addEventListener('touchstart', flap);
                  document.body.addEventListener('mousedown', flap);

                  function startCountdown() {
                    const countdownInterval = setInterval(() => {
                      countdown--;
                      if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        gameStarted = true;
                        startGameTimer();
                      }
                    }, 1000);
                  }

                  resetGame();
                })();
            }
        });

        let arbolChanDialogStep = 0;
        btnContinuar.addEventListener('click', function() {
            if (arbolChanDialogStep === 0) {
                if (currentLang === 'en') {
                    arbolChanTexto.innerHTML = "I will grant you a fair chance on a PING-PONG game.<br>Withstand 15 seconds of my attacks<br>and score 5 points during the brief seconds when I am not defending...<br>Only then, this duel between human and plant will be settled with dignity.";
                } else {
                    arbolChanTexto.innerHTML = "Le concederé una ocasión justa en un enfrentamiento de PING-PONG.<br>Resista 15 segundos de mis embates<br>y anote 5 puntos durante los breves segundos en que no defiendo...<br>Solo entonces, daremos este duelo por resuelto entre ser humano-planta con dignidad.";
                }
                arbolChanDialogStep = 1;
            } else {
                // --- AGREGAR AUDIO DE FONDO PARA EL JUEGO DE PONG ---
                // Si ya existe, elimínalo antes de crear uno nuevo
                let oldAudio = document.getElementById('pong-audio');
                if (oldAudio) oldAudio.remove();
                const audio = document.createElement('audio');
                audio.id = 'pong-audio';
                audio.src = 'pingpongtime.mp3';
                audio.loop = true;
                audio.autoplay = true;
                audio.style.display = 'none';
                document.body.appendChild(audio);

                document.body.innerHTML = `
                    <style>
                        #pong-container {
                            width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center;
                            background: url('fonde mesa.jpg') no-repeat center center, linear-gradient(180deg, #e8f5e9 0%, #178a2c 100%);
                            background-size: cover;
                            position: fixed; top: 0; left: 0;
                            flex-direction: column;
                        }
                        #pong-canvas {
                            background: transparent;
                            display: block;
                            margin: auto;
                            /* Zona de juego más pequeña para ver fondo */
                            width: 92vw;
                            height: 70vh;
                            max-width: 370px;
                            max-height: 620px;
                            aspect-ratio: 9/16;
                            border-radius: 18px;
                            box-shadow: 0 0 32px 4px #178a2c88, 0 0 0 4px #178a2c;
                            touch-action: none;
                        }
                        #pong-ost-label {
                            margin-top: 18px;
                            color: #fff;
                            font-family: 'Montserrat', Arial, sans-serif;
                            font-size: 1.1rem;
                            font-weight: bold;
                            text-shadow: 0 2px 8px #000, 0 0 8px #178a2c;
                            z-index: 20;
                            pointer-events: none;
                            user-select: none;
                            letter-spacing: 0.5px;
                            text-align: center;
                        }
                        #pong-end {
                            position: absolute;
                            top: 0; left: 0; width: 100vw; height: 100vh;
                            background: url('Fondo texto.jpg') no-repeat center center;
                            background-size: cover;
                            color: #178a2c;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center; /* centrado vertical */
                            z-index: 10;
                            font-family: 'Montserrat', Arial, sans-serif;
                            /* Eliminar padding/margin extra */
                        }
                        #pong-end .arbol-img {
                            width: 38vw;
                            max-width: 180px;
                            min-width: 90px;
                            margin-top: 2.5rem;
                            margin-bottom: 1.2rem;
                            filter: drop-shadow(0 4px 16px #fff);
                        }
                        #pong-end h2 {
                            font-size: 2.2rem;
                            margin-bottom: 2rem;
                            color: #178a2c;
                            text-align: center;
                            text-shadow: 0 2px 12px #fff, 0 0 12px #178a2c, 2px 2px 0 #fff;
                            margin-top: 0; /* quitar margen superior */
                        }
                        #pong-next-img {
                            width: 60vw;
                            max-width: 300px;
                            min-width: 120px;
                            height: 180px;
                            background: #fff;
                            margin: 0; /* quitar margen vertical */
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border-radius: 12px;
                            overflow: hidden;
                            box-shadow: 0 2px 12px #178a2c33;
                        }
                        #pong-end button {
                            font-size: 1.3rem;
                            background: #178a2c;
                            color: #fff;
                            border: 2px solid #fff;
                            border-radius: 8px;
                            padding: 0.7rem 2.5rem;
                            font-weight: bold;
                            font-family: 'Montserrat', Arial, sans-serif;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
                            cursor: pointer;
                            margin-top: 1.5rem;
                            margin-bottom: 2rem;
                        }
                        #pong-end button:active {
                            background: #176d13;
                            border: 2px solid #ffe44d;
                        }
                    </style>
                    <div id="pong-container">
                        <canvas id="pong-canvas"></canvas>
                        <div id="pong-ost-label">OST: Vampire Killer - Castlevania</div>
                    </div>
                `;
                // --- REINSERTAR EL AUDIO EN EL NUEVO BODY ---
                document.body.appendChild(audio);

                // Pong game logic (zona de juego más pequeña, IA casi invencible, velocidad de pelota constante)
                (function() {
                    const canvas = document.getElementById('pong-canvas');
                    const ctx = canvas.getContext('2d');
                    // --- Agrega la imagen de la raqueta IA ---
                    const tronkImg = new Image();
                    tronkImg.src = 'tronk.png';
                    // --- Imagen alternativa para la IA paralizada ---
                    const tronkquiImg = new Image();
                    tronkquiImg.src = 'tronkqui.png';

                    // --- Proporción 9:16, tablero horizontal ---
                    function getGameSize() {
                        // El canvas ya tiene tamaño fijo por CSS, así que usamos esas dimensiones
                        return { w: canvas.width, h: canvas.height };
                    }
                    function resizeCanvas() {
                        // Ajusta el tamaño real del canvas al tamaño mostrado
                        const rect = canvas.getBoundingClientRect();
                        canvas.width = rect.width;
                        canvas.height = rect.height;
                    }
                    resizeCanvas();
                    window.addEventListener('resize', resizeCanvas);

                    // --- Constantes y posiciones ---
                    function rel(val, axis) {
                        const { w, h } = getGameSize();
                        return axis === 'w' ? val * w : val * h;
                    }
                    // Raquetas horizontales (abajo/arriba)
                    function paddleW() { return rel(0.22, 'w'); }
                    function paddleH() { return rel(0.025, 'h'); }
                    function paddleMargin() { return rel(0.03, 'h'); }
                    function ballSize() { return rel(0.035, 'w'); }
                    function netH() { return rel(0.012, 'h'); }
                    function netSeg() { return rel(0.045, 'w'); }
                    function netGap() { return rel(0.025, 'w'); }

                    // --- NUEVAS VARIABLES PARA TEMPORIZADOR DE IA ---
                    let aiTimer = 15.0; // segundos restantes para movimiento (fijo en 15)
                    let aiFrozen = false;
                    let aiFreezeTimer = 0; // segundos restantes de congelamiento
                    let aiTimerLastUpdate = Date.now();

                    // Estado del juego
                    let player = { x: 0, y: 0, w: paddleW(), h: paddleH(), score: 0 };
                    let ai = { x: 0, y: 0, w: paddleW(), h: paddleH(), score: 0 };
                    let ball = { x: 0, y: 0, vx: 0, vy: 0, size: ballSize() };
                    let running = true;
                    let touchX = null;
                    // Elimina speedMultiplier y ballSpeedFactor para velocidad constante

                    function resetPositions(servingToPlayer = false) {
                        const { w, h } = getGameSize();
                        player.w = paddleW(); player.h = paddleH();
                        ai.w = paddleW(); ai.h = paddleH();
                        player.x = w/2 - player.w/2;
                        player.y = h - paddleMargin() - player.h;
                        ai.x = w/2 - ai.w/2;
                        ai.y = paddleMargin();
                        ball.size = ballSize();
                        ball.x = w/2 - ball.size/2;
                        ball.y = h/2 - ball.size/2;
                        // Serve ball
                        let angle = (Math.random() * 0.5 - 0.25); // -0.25 a 0.25 rad
                        let baseSpeed = rel(0.018, 'h'); // velocidad constante, un poco más rápida
                        if (servingToPlayer) {
                            ball.vy = -baseSpeed;
                            ball.vx = angle * baseSpeed * 2;
                        } else {
                            ball.vy = baseSpeed;
                            ball.vx = angle * baseSpeed * 2;
                        }
                        // Normaliza la velocidad para que siempre sea igual
                        let speed = Math.sqrt(ball.vx*ball.vx + ball.vy*ball.vy);
                        if (speed !== 0) {
                            ball.vx *= baseSpeed/speed;
                            ball.vy *= baseSpeed/speed;
                        }
                        // --- SOLO REINICIAR EL TEMPORIZADOR DE IA CUANDO SE INICIA EL JUEGO, NO EN CADA PUNTO ---
                        // No modificar aiTimer, aiFrozen, aiFreezeTimer aquí
                        aiTimerLastUpdate = Date.now();
                    }

                    // --- Decoración tipo ping pong ---
                    function drawTable() {
                        const { w, h } = getGameSize();
                        // Fondo azul tipo mesa de ping pong
                        ctx.save();
                        ctx.fillStyle = "#2b4fa2";
                        ctx.globalAlpha = 0.93;
                        ctx.fillRect(rel(0.03, 'w'), rel(0.02, 'h'), w - rel(0.06, 'w'), h - rel(0.04, 'h'));
                        ctx.globalAlpha = 1;
                        // Líneas blancas del borde
                        ctx.strokeStyle = "#fff";
                        ctx.lineWidth = rel(0.012, 'w');
                        ctx.strokeRect(rel(0.03, 'w'), rel(0.02, 'h'), w - rel(0.06, 'w'), h - rel(0.04, 'h'));
                        // Línea central blanca
                        ctx.beginPath();
                        ctx.moveTo(rel(0.03, 'w'), h/2);
                        ctx.lineTo(w - rel(0.03, 'w'), h/2);
                        ctx.setLineDash([rel(0.04, 'w'), rel(0.025, 'w')]);
                        ctx.lineWidth = rel(0.008, 'w');
                        ctx.stroke();
                        ctx.setLineDash([]);
                        // Red (gris claro)
                        ctx.beginPath();
                        ctx.strokeStyle = "#e0e0e0";
                        ctx.lineWidth = rel(0.012, 'h');
                        ctx.moveTo(rel(0.03, 'w'), h/2);
                        ctx.lineTo(w - rel(0.03, 'w'), h/2);
                        ctx.stroke();
                        ctx.restore();
                    }

                    function drawScore() {
                        const { w, h } = getGameSize();
                        ctx.font = `bold ${rel(0.08, 'w')}px 'Montserrat', Arial, sans-serif`;
                        ctx.textAlign = "center";
                        ctx.fillStyle = "#ffe44d";
                        ctx.shadowColor = "#178a2c";
                        ctx.shadowBlur = 8;
                        ctx.fillText(player.score, w/2, h - rel(0.07, 'h'));
                        ctx.fillText(ai.score, w/2, rel(0.11, 'h'));
                        ctx.shadowBlur = 0;
                    }

                    function drawPaddle(p, isPlayer) {
                        ctx.save();
                        if (!isPlayer) {
                            // --- Dibuja la imagen "tronk.png" como raqueta de la IA ---
                            // Si está congelada, cambia a "tronkqui.png"
                            if (aiFrozen) {
                                // Dibuja la imagen alternativa para la IA paralizada
                                if (tronkquiImg.complete) {
                                    ctx.drawImage(tronkquiImg, p.x, p.y, p.w, p.h);
                                } else {
                                    tronkquiImg.onload = () => {
                                        ctx.drawImage(tronkquiImg, p.x, p.y, p.w, p.h);
                                    };
                                }
                            } else {
                                // Imagen normal
                                if (tronkImg.complete) {
                                    ctx.drawImage(tronkImg, p.x, p.y, p.w, p.h);
                                } else {
                                    tronkImg.onload = () => {
                                        ctx.drawImage(tronkImg, p.x, p.y, p.w, p.h);
                                    };
                                }
                            }
                        } else {
                            ctx.fillStyle = "#ffe44d";
                            ctx.shadowColor = "#178a2c";
                            ctx.shadowBlur = 8;
                            ctx.fillRect(p.x, p.y, p.w, p.h);
                        }
                        ctx.restore();
                    }

                    // --- DIBUJAR TEMPORIZADOR DE IA ---
                    function drawAITimer() {
                        const { w } = getGameSize();
                        ctx.save();
                        ctx.font = `bold ${rel(0.06, 'w')}px 'Montserrat', Arial, sans-serif`;
                        ctx.textAlign = "center";
                        ctx.textBaseline = "top";
                        // Color azul claro durante la quietud, blanco normal
                        let color = aiFrozen ? "#b7d3e6" : "#fff";
                        // Sombra: azul oscuro si congelada, verde normal si no
                        ctx.shadowColor = aiFrozen ? "#1a237e" : "#178a2c";
                        ctx.shadowBlur = 8;
                        let timerValue = aiFrozen ? aiFreezeTimer : aiTimer;
                        let timerText = timerValue.toFixed(1);
                        const timerX = ai.x + ai.w/2;
                        const timerY = ai.y + ai.h + rel(0.012, 'h');
                        ctx.fillStyle = color;
                        ctx.fillText(timerText, timerX, timerY);
                        ctx.restore();
                    }

                    function drawBall() {
                        ctx.save();
                        ctx.fillStyle = "#fff";
                        ctx.shadowColor = "#ffe44d"; // estela original amarilla
                        ctx.shadowBlur = 8;
                        ctx.beginPath();
                        ctx.arc(ball.x + ball.size/2, ball.y + ball.size/2, ball.size/2, 0, 2*Math.PI);
                        ctx.fill();
                        ctx.restore();
                    }

                    function draw() {
                        const { w, h } = getGameSize();
                        ctx.clearRect(0, 0, w, h);
                        drawTable();
                        drawScore();
                        drawPaddle(player, true);
                        drawPaddle(ai, false);
                        drawBall();
                        // --- DIBUJAR TEMPORIZADOR DE IA DE FORMA CLARA Y VISIBLE ---
                        drawAITimer();
                    }

                    function clamp(val, min, max) {
                        return Math.max(min, Math.min(max, val));
                    }

                    // Touch/mouse controls for player paddle (horizontal)
                    function handleMoveFromCanvas(x) {
                        const { w } = getGameSize();
                        player.x = clamp(x - player.w/2, rel(0.03, 'w'), w - rel(0.03, 'w') - player.w);
                    }
                    function getCanvasRelativeX(e) {
                        const rect = canvas.getBoundingClientRect();
                        if (e.touches && e.touches.length > 0) {
                            return (e.touches[0].clientX - rect.left) * (canvas.width / rect.width);
                        } else if (typeof e.clientX === "number") {
                            return (e.clientX - rect.left) * (canvas.width / rect.width);
                        }
                        return 0;
                    }
                    canvas.addEventListener('touchstart', function(e) {
                        handleMoveFromCanvas(getCanvasRelativeX(e));
                        e.preventDefault();
                    });
                    canvas.addEventListener('touchmove', function(e) {
                        handleMoveFromCanvas(getCanvasRelativeX(e));
                        e.preventDefault();
                    });
                    canvas.addEventListener('mousedown', function(e) {
                        handleMoveFromCanvas(getCanvasRelativeX(e));
                        touchX = true;
                    });
                    canvas.addEventListener('mousemove', function(e) {
                        if (touchX) {
                            handleMoveFromCanvas(getCanvasRelativeX(e));
                        }
                    });
                    canvas.addEventListener('mouseup', function() {
                        touchX = null;
                    });
                    canvas.addEventListener('mouseleave', function() {
                        touchX = null;
                    });

                    // IA casi invencible: sigue la bola perfectamente, sin límite de velocidad
                    function aiMove() {
                        if (aiFrozen) return; // No mover si está congelada
                        const { w } = getGameSize();
                        let center = ai.x + ai.w/2;
                        let target = ball.x + ball.size/2;
                        let dx = target - center;
                        // Sin límite de velocidad: mueve la paleta directamente al centro de la bola
                        ai.x += dx;
                        // Clamp para no salirse del área de juego
                        ai.x = clamp(ai.x, rel(0.03, 'w'), w - rel(0.03, 'w') - ai.w);
                    }

                    // --- ACTUALIZAR TEMPORIZADOR DE IA ---
                    function updateAITimer(dt) {
                        if (!aiFrozen) {
                            aiTimer -= dt;
                            if (aiTimer <= 0) {
                                aiFrozen = true;
                                aiFreezeTimer = 3.0;
                                aiTimer = 0;
                            }
                        } else {
                            aiFreezeTimer -= dt;
                            if (aiFreezeTimer <= 0) {
                                aiFrozen = false;
                                aiTimer = 15.0; // SIEMPRE vuelve a 15 segundos
                                aiFreezeTimer = 0;
                            }
                        }
                    }

                    // Ball physics and collision (horizontal paddles)
                    function update() {
                        const { w, h } = getGameSize();
                        // --- TEMPORIZADOR DE IA ---
                        let now = Date.now();
                        let dt = (now - aiTimerLastUpdate) / 1000;
                        aiTimerLastUpdate = now;
                        if (running) updateAITimer(dt);

                        // Move ball
                        ball.x += ball.vx;
                        ball.y += ball.vy;

                        // Wall collision (left/right)
                        if (ball.x < 0) {
                            ball.x = 0; ball.vx *= -1;
                        }
                        if (ball.x + ball.size > w) {
                            ball.x = w - ball.size; ball.vx *= -1;
                        }

                        // Paddle collision (player, abajo)
                        if (
                            ball.y + ball.size >= player.y &&
                            ball.y + ball.size <= player.y + player.h + rel(0.01, 'h') &&
                            ball.x + ball.size > player.x &&
                            ball.x < player.x + player.w &&
                            ball.vy > 0
                        ) {
                            ball.y = player.y - ball.size;
                            ball.vy *= -1;
                            // Efecto según dónde pega
                            let hit = ((ball.x + ball.size/2) - (player.x + player.w/2)) / (player.w/2);
                            ball.vx += hit * rel(0.006, 'w');
                            // Mantener velocidad constante SIEMPRE
                            let baseSpeed = rel(0.018, 'h');
                            let speed = Math.sqrt(ball.vx*ball.vx + ball.vy*ball.vy);
                            if (speed !== 0) {
                                ball.vx *= baseSpeed/speed;
                                ball.vy *= baseSpeed/speed;
                            }
                        }
                        // Paddle collision (AI, arriba)
                        if (
                            ball.y <= ai.y + ai.h &&
                            ball.y >= ai.y - rel(0.01, 'h') &&
                            ball.x + ball.size > ai.x &&
                            ball.x < ai.x + ai.w &&
                            ball.vy < 0
                        ) {
                            ball.y = ai.y + ai.h;
                            ball.vy *= -1;
                            let hit = ((ball.x + ball.size/2) - (ai.x + ai.w/2)) / (ai.w/2);
                            ball.vx += hit * rel(0.006, 'w');
                            // Mantener velocidad constante SIEMPRE
                            let baseSpeed = rel(0.018, 'h');
                            let speed = Math.sqrt(ball.vx*ball.vx + ball.vy*ball.vy);
                            if (speed !== 0) {
                                ball.vx *= baseSpeed/speed;
                                ball.vy *= baseSpeed/speed;
                            }
                        }

                        // Score
                        if (ball.y < 0) {
                            player.score++;
                            // NO aumentar velocidad nunca
                            if (player.score >= 5) {
                                running = false;
                                setTimeout(() => showEndScreen(true), 700);
                            } else {
                                resetPositions(false);
                                // Ya no sumamos tiempo, el contador siempre es 15
                            }
                        }
                        if (ball.y + ball.size > getGameSize().h) {
                            ai.score++;
                            // NO aumentar velocidad nunca
                            if (ai.score >= 5) {
                                running = false;
                                setTimeout(() => showEndScreen(false), 700);
                            } else {
                                resetPositions(true);
                                // Ya no reiniciamos ni sumamos tiempo, el contador siempre es 15
                            }
                        }
                    }

                    function gameLoop() {
                        if (!running) return;
                        aiMove();
                        update();
                        draw();
                        requestAnimationFrame(gameLoop);
                    }

                    function showEndScreen(playerWon) {
                        const pongContainer = document.getElementById('pong-container');
                        // Elimina el texto OST si existe
                        const ostLabel = document.getElementById('pong-ost-label');
                        if (ostLabel) ostLabel.remove();
                        let html = '';
                        const lang = currentLang || 'es';

                        if (playerWon) {
                            // Exterior blanco, interior responsivo igual que los otros diálogos
                            html = `
                                <div id="pong-end" style="background: #fff; color: #178a2c; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; font-family: 'Montserrat', Arial, sans-serif; width: 100vw; height: 100vh; position: absolute; top: 0; left: 0;">
                                    <div class="arbol-chan-content" style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100vw; height: 100vh; max-width: 430px; max-height: 932px; min-width: 320px; min-height: 568px; margin: 0 auto; background: url('Fondo texto.jpg') no-repeat center center; background-size: cover; border-radius: 20px; box-shadow: 0 0 20px 2px rgba(0,0,0,0.2); position: relative;">
                                        <img src="DonArbol.png" class="arbol-chan-img visible" alt="Don Árbolito" style="width: 60vw; max-width: 220px; min-width: 120px; margin-top: 0; opacity: 1; transform: translateY(0); transition: opacity 1.2s, transform 1.2s cubic-bezier(.77,0,.18,1);" />
                                        <div class="arbol-chan-titulo" style="font-family: 'Montserrat', Arial, sans-serif; color: #178a2c; font-size: 2.5rem; font-weight: bold; margin-top: 1.2rem; margin-bottom: 0.7rem; text-align: center; text-shadow: 0 2px 12px #fff, 0 0 12px #178a2c, 2px 2px 0 #fff;">Don Árbolito</div>
                                        <div class="arbol-chan-texto" style="color: #fff; font-family: 'Roboto', Arial, sans-serif; font-size: 1.2rem; margin-top: 0.5rem; margin-bottom: 1.2rem; text-align: center; text-shadow: 0 2px 8px #000;">
                                            ${
                                                lang === 'en'
                                                ? `Well done, User. You have shown courage and precision.<br><br>
                                                    The clue I will give you is a picture taken somewhere in this park.<br>
                                                    Go, observe carefully... and you will find the next code.`
                                                : `Bien hecho, Usuario. Ha demostrado valor y precisión.<br><br>
                                                    La pista que le brindaré es una imagen tomada en algún rincón de este parque.<br>
                                                    Vaya, observe con atención… y encontrará el siguiente código....y recuerda, no te rindas!.`
                                            }
                                        </div>
                                        <button id="pong-ver-pista" class="btn-continuar" style="margin-top: 0.5rem; font-size: 1.2rem; background: #178a2c; color: #fff; border: 2px solid #fff; border-radius: 8px; padding: 0.7rem 2.5rem; font-weight: bold; font-family: 'Montserrat', Arial, sans-serif; box-shadow: 0 2px 8px rgba(0,0,0,0.12); cursor: pointer; transition: background 0.2s, border 0.2s;">${lang === 'en' ? 'See clue' : 'Ver pista'}</button>
                                    </div>
                                </div>
                            `;
                        } else {
                            html = `
                                <div id="pong-end">
                                    <img src="DonArbol.png" class="arbol-img" alt="Don Árbolito" />
                                    <h2>${lang === 'en' ? 'How unfortunate...' : 'Qué desafortunado...'}</h2>
                                    <button id="pong-retry">${textos[lang].continuar}</button>
                                </div>
                            `;
                        }
                        pongContainer.insertAdjacentHTML('beforeend', html);

                        if (playerWon) {
                            document.getElementById('pong-ver-pista').onclick = function() {
                                const pongEnd = document.getElementById('pong-end');
                                pongEnd.innerHTML = `
                                    <div class="arbol-chan-content" style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100vw; height: 100vh; max-width: 430px; max-height: 932px; min-width: 320px; min-height: 568px; margin: 0 auto; background: url('Fondo texto.jpg') no-repeat center center; background-size: cover; border-radius: 20px; box-shadow: 0 0 20px 2px rgba(0,0,0,0.2); position: relative;">
                                        <h2 style="margin-top:0;">${textos[lang].pongWin}</h2>
                                        <div id="pong-next-img" style="margin:0; padding:0; width: 60vw; max-width: 300px; min-width: 120px; height: 180px; background: #fff; display: flex; align-items: center; justify-content: center; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px #178a2c33;">
                                            <img src="gym.jpeg" alt="Pista" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:12px 12px 12px 12px;">
                                        </div>
                                        <button id="pong-continue" style="font-size:1.3rem;background:#178a2c;color:#fff;border:2px solid #fff;border-radius:8px;padding:0.7rem 2.5rem;font-weight:bold;font-family:'Montserrat',Arial,sans-serif;box-shadow:0 2px 8px rgba(0,0,0,0.12);cursor:pointer;margin-top:1.5rem;margin-bottom:2rem;">${textos[lang].continuar}</button>
                                    </div>
                                `;
                                document.getElementById('pong-continue').onclick = function() {
                                    location.reload();
                                };
                            };
                        }
                        if (!playerWon) {
                            document.getElementById('pong-retry').onclick = function() {
                                location.reload();
                            };
                        }
                    }

                    // Responsive: update paddle/ball sizes on resize
                    function updateSizes() {
                        resetPositions();
                    }
                    window.addEventListener('resize', function() {
                        updateSizes();
                    });

                    // Start game
                    player.score = 0; ai.score = 0;
                    aiTimer = 15.0;
                    aiFrozen = false;
                    aiFreezeTimer = 0;
                    resetPositions(false);
                    running = true;
                    gameLoop();
                })();
            }
        });

    </script>
</body>
</html>
